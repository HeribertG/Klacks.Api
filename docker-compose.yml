services:
  postgres:
    image: postgres:17-alpine
    container_name: klacks-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: Klacks
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - klacks_network

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: klacks-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@klacks.app}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - klacks_network

  klacks-api:
    build:
      context: .
      dockerfile: ./Klacks.Api/Dockerfile
    container_name: klacks-api
    restart: unless-stopped
    expose:
      - "5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=Klacks;Username=admin;Password=${POSTGRES_PASSWORD:-admin}
    depends_on:
      - postgres
    networks:
      - klacks_network

  klacks-ui:
    build: ./Klacks.Ui
    container_name: klacks-ui
    restart: unless-stopped
    expose:
      - "80"
    depends_on:
      - klacks-api
    networks:
      - klacks_network

  klacks-blazor:
    build: ./Klacks.Blazor
    container_name: klacks-blazor
    restart: unless-stopped
    ports:
      - "7002:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
    depends_on:
      - klacks-api
    networks:
      - klacks_network

  klacks-marketplace:
    build: ./Klacks.Marketplace
    container_name: klacks-marketplace
    restart: unless-stopped
    ports:
      - "7003:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:80
    volumes:
      - marketplace_data:/app/data
    networks:
      - klacks_network

  nginx-proxy:
    image: nginx:alpine
    container_name: klacks-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "3000:3000"
      - "5000:5000"
      - "5443:5443"
      - "7443:7443"
      - "5553:5553"
      - "7553:7553"
    volumes:
      - ./nginx-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx-proxy/certs:/etc/nginx/certs:ro
    depends_on:
      - klacks-ui
      - klacks-api
      - klacks-blazor
      - pgadmin
    networks:
      - klacks_network

networks:
  klacks_network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  marketplace_data:
    driver: local
